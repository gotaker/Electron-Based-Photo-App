<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PhotoVault Diagnostic</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        button { padding: 10px 20px; margin: 5px; background: #333; color: #0f0; border: 1px solid #0f0; cursor: pointer; }
        button:hover { background: #0f0; color: #000; }
        pre { background: #000; padding: 10px; border: 1px solid #0f0; overflow-x: auto; }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
    </style>
</head>
<body>
    <h1>PhotoVault Diagnostic Tool</h1>
    
    <div>
        <button onclick="testStorage()">1. Test Storage</button>
        <button onclick="testImport()">2. Test Import</button>
        <button onclick="testGetPhotos()">3. Test Get Photos</button>
        <button onclick="testRender()">4. Test Render</button>
        <button onclick="clearData()">5. Clear All Data</button>
    </div>
    
    <pre id="output">Ready...</pre>
    <div id="gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;"></div>
    
    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'normal') {
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            console.log(msg);
            output.innerHTML += `<span class="${color}">${msg}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clear() {
            output.innerHTML = '';
        }
        
        async function testStorage() {
            clear();
            log('=== TESTING STORAGE ===\n');
            
            try {
                const info = await window.electronAPI.getStorageInfo();
                log(JSON.stringify(info, null, 2), 'success');
            } catch (error) {
                log('ERROR: ' + error.message, 'error');
            }
        }
        
        async function testImport() {
            clear();
            log('=== TESTING IMPORT ===\n');
            
            try {
                log('Opening file dialog...');
                const result = await window.electronAPI.openFileDialog();
                
                if (!result.success) {
                    log('No files selected', 'warning');
                    return;
                }
                
                log('\nFile dialog result:', 'success');
                log(JSON.stringify(result, null, 2));
                
                for (let i = 0; i < result.files.length; i++) {
                    const file = result.files[i];
                    log(`\n--- FILE ${i + 1} ---`);
                    log('ID: ' + file.id);
                    log('Name: ' + file.name);
                    log('storagePath: ' + file.storagePath);
                    log('relativePath: ' + file.relativePath);
                    log('thumbnailPath: ' + file.thumbnailPath);
                    log('originalPath: ' + file.originalPath);
                    log('fileSize: ' + file.fileSize);
                    
                    // Check if all required fields exist
                    const required = ['id', 'name', 'storagePath', 'relativePath', 'thumbnailPath'];
                    const missing = required.filter(field => !file[field]);
                    
                    if (missing.length > 0) {
                        log('MISSING FIELDS: ' + missing.join(', '), 'error');
                    } else {
                        log('All required fields present', 'success');
                    }
                    
                    // Save the photo
                    const photo = {
                        id: file.id,
                        name: file.name,
                        storagePath: file.storagePath,
                        relativePath: file.relativePath,
                        thumbnailPath: file.thumbnailPath,
                        originalPath: file.originalPath,
                        date: new Date().toLocaleDateString(),
                        dateAdded: new Date().toISOString(),
                        favorite: false,
                        faces: 0,
                        album: null,
                        tags: [],
                        fileSize: file.fileSize
                    };
                    
                    log('\nSaving photo...');
                    const saveResult = await window.electronAPI.savePhoto(photo);
                    
                    if (saveResult.success) {
                        log('SAVED SUCCESSFULLY', 'success');
                    } else {
                        log('SAVE FAILED: ' + saveResult.error, 'error');
                    }
                }
                
            } catch (error) {
                log('ERROR: ' + error.message, 'error');
                log(error.stack, 'error');
            }
        }
        
        async function testGetPhotos() {
            clear();
            log('=== TESTING GET PHOTOS ===\n');
            
            try {
                const result = await window.electronAPI.getPhotos();
                
                log('Result:', result.success ? 'success' : 'error', result.success ? 'success' : 'error');
                log('Photo count: ' + result.photos.length);
                
                if (result.photos.length === 0) {
                    log('No photos in database', 'warning');
                    return;
                }
                
                result.photos.forEach((photo, index) => {
                    log(`\n--- PHOTO ${index + 1} ---`);
                    log('ID: ' + photo.id);
                    log('Name: ' + photo.name);
                    log('storagePath: ' + (photo.storagePath || 'MISSING!'), photo.storagePath ? 'success' : 'error');
                    log('relativePath: ' + (photo.relativePath || 'MISSING!'), photo.relativePath ? 'success' : 'error');
                    log('thumbnailPath: ' + (photo.thumbnailPath || 'MISSING!'), photo.thumbnailPath ? 'success' : 'error');
                    log('Has src: ' + (!!photo.src), photo.src ? 'success' : 'error');
                    
                    if (photo.src) {
                        log('Src length: ' + photo.src.length + ' chars', 'success');
                        log('Src starts with: ' + photo.src.substring(0, 50) + '...');
                    } else {
                        log('SRC IS MISSING - PHOTO WILL NOT DISPLAY!', 'error');
                    }
                });
                
            } catch (error) {
                log('ERROR: ' + error.message, 'error');
            }
        }
        
        async function testRender() {
            clear();
            log('=== TESTING RENDER ===\n');
            
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            try {
                const result = await window.electronAPI.getPhotos();
                
                if (result.photos.length === 0) {
                    log('No photos to render', 'warning');
                    return;
                }
                
                log('Rendering ' + result.photos.length + ' photos...\n');
                
                result.photos.forEach((photo, index) => {
                    log(`Photo ${index + 1}: ${photo.name}`);
                    
                    if (!photo.src) {
                        log('  ❌ No src - cannot render', 'error');
                        return;
                    }
                    
                    log('  ✅ Has src (' + photo.src.length + ' chars)', 'success');
                    
                    const card = document.createElement('div');
                    card.style.cssText = 'border: 1px solid #0f0; padding: 10px; background: #000;';
                    
                    const img = document.createElement('img');
                    img.src = photo.src;
                    img.alt = photo.name;
                    img.style.cssText = 'width: 100%; height: 200px; object-fit: cover;';
                    
                    img.onerror = () => {
                        log(`  ❌ Image failed to load: ${photo.name}`, 'error');
                        img.style.display = 'none';
                        card.innerHTML += '<div style="color: red;">Failed to load image</div>';
                    };
                    
                    img.onload = () => {
                        log(`  ✅ Image loaded successfully: ${photo.name}`, 'success');
                    };
                    
                    const name = document.createElement('div');
                    name.textContent = photo.name;
                    name.style.cssText = 'margin-top: 5px; font-size: 12px;';
                    
                    card.appendChild(img);
                    card.appendChild(name);
                    gallery.appendChild(card);
                });
                
            } catch (error) {
                log('ERROR: ' + error.message, 'error');
            }
        }
        
        async function clearData() {
            if (!confirm('Clear all photos from database?')) return;
            
            clear();
            log('=== CLEARING DATA ===\n');
            
            try {
                const result = await window.electronAPI.clearAllData();
                if (result.success) {
                    log('All data cleared', 'success');
                } else {
                    log('Clear failed: ' + result.error, 'error');
                }
            } catch (error) {
                log('ERROR: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
